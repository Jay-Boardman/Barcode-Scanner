<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pathology Supplies Scanner</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide/dist/lucide.min.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f3f3f3;
      color: #333;
      padding: 20px;
      margin: 0;
    }
    h2 {
      color: #005eb8;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
    }
    label {
      font-weight: 500;
      display: block;
      margin-top: 10px;
    }
    input, textarea {
      width: 100%;
      font-size: 16px;
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #005eb8;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px;
      margin: 5px 1%;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    button:hover {
      background-color: #004a90;
    }
    button i {
      vertical-align: middle;
      margin-right: 5px;
      stroke-width: 2;
      width: 20px;
      height: 20px;
    }
    .list {
      margin-top: 20px;
    }
    .item {
      background: white;
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-weight: 500;
    }
    .item-controls {
      display: flex;
      gap: 8px;
    }
    .badge {
      background-color: #28a745;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 14px;
      min-width: 30px;
      text-align: center;
    }
    @media (max-width: 600px) {
      .top-buttons button { width: 100%; margin: 5px 0; }
    }
  </style>
</head>
<body>
  <h2>Pathology Supplies Scanner</h2>

  <label for="codeInput">Scanned Code:</label>
  <input id="codeInput" type="text" autofocus placeholder="Scan or enter barcode">

  <label for="qtyInput">Quantity:</label>
  <input id="qtyInput" type="number" value="1" min="1">

  <div class="top-buttons">
    <button id="addBtn" type="button"><i data-lucide="plus-circle"></i> Add Item</button>
    <button id="exportBtn" type="button"><i data-lucide="file-text"></i> Export Data</button>
    <button id="downloadBtn" type="button"><i data-lucide="download"></i> Download File</button>
    <button id="clearBtn" type="button"><i data-lucide="trash-2"></i> Clear All</button>
  </div>

  <div class="list" id="list"></div>

  <h3>Output String</h3>
  <textarea id="output" rows="6" style="width:100%; border-radius:8px; padding:10px;"></textarea>

  <script>
    let items = [];
    const codeInput = document.getElementById('codeInput');
    const qtyInput = document.getElementById('qtyInput');
    const listDiv = document.getElementById('list');
    const output = document.getElementById('output');

    function addItem() {
      const code = codeInput.value.trim();
      const qty = parseInt(qtyInput.value, 10);

      if (!code) {
        alert("Please scan or enter a barcode.");
        return;
      }
      if (qty <= 0) {
        alert("Quantity must be at least 1.");
        return;
      }

      // Merge duplicates: check if item already exists
      const existing = items.find(i => i.code === code);
      if (existing) {
        existing.qty += qty;
      } else {
        items.push({ code, qty });
      }

      renderList();

      // Reset for next scan
      codeInput.value = "";
      qtyInput.value = 1;
      codeInput.focus();
    }

    function renderList() {
      listDiv.innerHTML = "";
      items.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <span>${item.code}</span>
          <span class="badge">${item.qty}</span>
          <div class="item-controls">
            <button onclick="editItem(${index})" title="Edit"><i data-lucide="pencil"></i></button>
            <button onclick="deleteItem(${index})" title="Delete"><i data-lucide="trash-2"></i></button>
          </div>
        `;
        listDiv.appendChild(div);
      });
      lucide.createIcons(); // re-render icons
    }

    function editItem(index) {
      const newQty = prompt("Enter new quantity for " + items[index].code, items[index].qty);
      if (newQty !== null) {
        const qty = parseInt(newQty, 10);
        if (!isNaN(qty) && qty > 0) {
          items[index].qty = qty;
          renderList();
        } else {
          alert("Invalid quantity.");
        }
      }
    }

    function deleteItem(index) {
      if (confirm("Remove " + items[index].code + " from the list?")) {
        items.splice(index, 1);
        renderList();
      }
    }

    function exportData() {
      const result = items.map(i => `${i.code} ${i.qty}`).join("\n");
      output.value = result;
    }

    function downloadData() {
      exportData();
      const text = output.value;
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "scanned-items.txt";

      if (typeof a.download === "undefined") {
        window.open(url, "_blank");
      } else {
        a.click();
      }

      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function clearAll() {
      items = [];
      listDiv.innerHTML = "";
      output.value = "";
      codeInput.value = "";
      qtyInput.value = 1;
      codeInput.focus();
    }

    // Event listeners
    document.getElementById("addBtn").addEventListener("click", addItem);
    document.getElementById("exportBtn").addEventListener("click", exportData);
    document.getElementById("downloadBtn").addEventListener("click", downloadData);
    document.getElementById("clearBtn").addEventListener("click", clearAll);

    // Workflow: barcode → qty → add
    codeInput.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        qtyInput.focus();
        qtyInput.select(); // highlight the "1"
      }
    });

    qtyInput.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        addItem();
      }
    });

    // Initialize Lucide icons
    lucide.createIcons();

    // Service worker registration
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js")
          .catch(err => console.error("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
